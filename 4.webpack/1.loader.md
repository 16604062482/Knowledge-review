- 关于 webpack 的工作流程，以下几步：

  > 参数解析
  > 找到入口文件
  > 调用 Loader 编译文件
  > 遍历 AST，收集依赖
  > 生成 Chunk
  > 输出文件

- loader：将内容翻译成 webpack 能处理的 js 代码
- plugin：深度介入 webpack 的构建过程，重塑构建逻辑

- Loader 通常接受三个参数：

  - source：资源输入（可以将第一个 loader 作为资源文件内容）
  - sourceMap：代码的 sourceMap 结构
  - data：loader 链上的其他信息

- loader 的返回结果是 string 或者 buffer

- 分类：

  - 普通 loade：没有任何配置

  - 前置 loader：enforce 属性配置 pre

  - 后置 loader：enforce 属性配置 post

  - 行内 loader：使用！分割

  ```js
  module: {
    rules: [
      {
        test: /\.js$/,
        use: ["pre-loader"],
        enforce: "pre",
      },
      {
        test: /\.js$/,
        use: ["normal-loader"],
      },
      {
        test: /\.js$/,
        use: ["post-loader"],
        enforce: "post",
      },
    ];
  }
  ```

- line-loader：

  ```js
  require("liline-loader!./文件名.js"); //使用inline-laoder处理这个文件
  ```

- 执行顺序： pre-loader > normal-loader > inline-loader > post-loader
- loader 配置符号：

  > !【跳过 normal-loader】
  > -!【跳过 normal-loader + pre-loader】
  > !!【跳过 normal-loader + pre-loader + post-loader】,只保留 inline

  ```js
  require("!liline-loader!./文件名.js");
  require("-!liline-loader!./文件名.js");
  ```

- loader 的两个执行阶段：

  - normal 部分 + pitch 阶段，先执行 pitch 部分，再执行 normal 部分

  ```js
  function loader(content) {
    return content;
  }
  loader.pitch = function () {};
  moudles.exports = loader;
  ```

  - pitch 阶段执行顺序：post>inline>normal>pre

  - normal 阶段顺序：pre>normal>inline>post
    > normal-loader 本质就是 loader 本身，pitch-loader 是 loader 上的 pitch 属性
    > pitch-loader 的应用场景：loader 需要依赖上一个 loader，但是上一个 loader 的 normal 函数返回的不是资源内容,比如 js 脚本（loader 应该返回 string 或者 buffer），你的 loader 逻辑应该放在 pitch 里，先处理上一个 loader 的返回结果

- loader 获取配置参数

  - loader-utils（webpack4 之前）
  - this.query（webpack5）

- 异步 loader：默认都是同步的，可以手动开启异步

  ```js
  module.exports = function (source) {
    const callback = this.async(); // 告诉 webpack 这次转换是异步的
    // 异步逻辑
    someAsyncOperation(content, function (err, result) {
      if (err) return callback(err);
      // 通过 callback 来返回异步处理的结果,参数错误优先
      callback(null, result, map, meta);
    });
  };
  ```

- api：
  - this.callback():在 Loader 中，通常使用 return 来返回一个 strign 或者 Buffer。如果需要返回多个结果值时，就需要使用 this.callback，定义如下：
    ```js
        this.callback(
            // 无法转换时返回 Error，其余情况都返回 null
            err: Error | null,
            // 转换结果
            content: string | Buffer,
            // source map，方便调试用的
            sourceMap?: SourceMap,
            // 可以是任何东西。比如 ast
            meta?: any
        );
    ```
  - this.cacheable()：是否开启loader缓存
    > 有些情况下，有些操作需要耗费大量时间，每一次调用 Loader 转换时都会执行这些费时的操作。
    > 在处理这类费时的操作时， webapck 会默认缓存所有 Loader 的处理结果，只有当被处理的文件发生变化时，才会重新调用 Loader 去执行转换操作。
    > webpack 是默认可缓存的，可以执行 this.cacheable(false) 手动关闭缓存。

    - this.resource：当前处理文件的完整请求路径，包括 query，比如 /src/App.vue?type=templpate。

    - this.resourcePath：当前处理文件的路径，不包括 query，比如 /src/App.vue。

